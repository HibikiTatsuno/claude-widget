# claude-widget

> macOS desktop widget for visualizing Claude Code usage statistics and GitHub PRs with Apple Liquid Glass design

## Overview

claude-widget is a real-time desktop widget for macOS that displays Claude Code usage statistics and GitHub Pull Requests. Built on Ãœbersicht widget engine, it provides cost tracking, session management, GitHub PR monitoring, and interactive features with a modern glass-morphism UI design.

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    macOS Desktop                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Ãœbersicht Widget Engine                                    â”‚
â”‚  â””â”€â”€ claude-sessions.jsx (UI Layer, 10s refresh)           â”‚
â”‚      â”œâ”€â”€ Left Panel: Claude Usage & Sessions               â”‚
â”‚      â””â”€â”€ Right Panel: GitHub Pull Requests                 â”‚
â”‚              â†“                                              â”‚
â”‚  Cache Files (~/.claude/cache/)                            â”‚
â”‚  â”œâ”€â”€ usage-30d.json (main data)                            â”‚
â”‚  â”œâ”€â”€ widget-hidden.flag (visibility state)                 â”‚
â”‚  â””â”€â”€ pending-input/*.pending (notification flags)          â”‚
â”‚              â†‘                                              â”‚
â”‚  launchd (com.claude.usage-cache.plist, 60s interval)      â”‚
â”‚  â””â”€â”€ update-usage-cache.sh (Data Collection Layer)         â”‚
â”‚              â†“                                              â”‚
â”‚  Data Sources                                               â”‚
â”‚  â”œâ”€â”€ ccusage CLI (cost/token statistics)                   â”‚
â”‚  â”œâ”€â”€ ~/.claude/history.jsonl (session history)             â”‚
â”‚  â”œâ”€â”€ ~/.claude/projects/*/ (session files)                 â”‚
â”‚  â”œâ”€â”€ ps + lsof (active process detection)                  â”‚
â”‚  â””â”€â”€ gh CLI (GitHub PR data)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Files

- `/claude-sessions.jsx`: Main widget UI component (JSX/React-like)
- `/update-usage-cache.sh`: Background data collection script (Bash)
- `/com.claude.usage-cache.plist`: launchd configuration for scheduled execution
- `/README.md`: Installation and usage documentation

## Features

### Cost Visualization
- 30-day cost bar chart with color-coded bars (red: high, orange: medium, blue: recent)
- Daily cost labels for the last 7 days
- Summary statistics: 30-day total, 7-day total, today's cost
- Total token count with K/M suffix formatting

### Session Management
- Active sessions: Real-time detection of running Claude processes
- Completed sessions: Recently finished sessions (last 2 hours)
- Session display names extracted from history
- Project/working directory information
- Bell notification indicator: Shows ğŸ”” when Claude needs user input (via hooks)

### GitHub Pull Requests Panel
- Real-time PR list for authenticated user (`gh pr list --author @me`)
- Repository name with clickable link to GitHub
- PR title with link to PR page
- Mergeable status indicator (checkmark/X)
- Review decision indicator (Approved/Changes Requested/Review Required)
- Opens links in default browser

### Interactive Features
- Clickable session IDs: Opens Ghostty terminal and resumes session with `claude --resume`
- Clickable PR links: Opens GitHub in browser
- Hide/Show widget: Toggle visibility with close (Ã—) button and minimized state (C button)
- Scrollable content for overflow handling

### UI Design
- Apple Liquid Glass style with blur effects and gradients
- Two-column layout (50% width, 70% height of viewport)
- Left column: Claude usage statistics and sessions
- Right column: GitHub Pull Requests
- Dark mode optimized color scheme (#1a1a1a base)
- Percentage-based layout for different screen sizes

## Data Flow

1. **Collection (every 60s)**: `update-usage-cache.sh` runs via launchd
   - Fetches cost/token data from `ccusage daily --json`
   - Parses `~/.claude/history.jsonl` for session metadata
   - Detects active processes via `ps aux` and `lsof`
   - Scans `~/.claude/projects/*/` for completed sessions
   - Writes combined JSON to `~/.claude/cache/usage-30d.json`

2. **Display (every 10s)**: `claude-sessions.jsx` refreshes
   - Reads cache file and hidden flag
   - Renders UI with current data
   - Handles user interactions

## Cache Data Structure

```json
{
  "daily": [
    {"date": "2025-01-14", "totalCost": 0.05, "totalTokens": 5000}
  ],
  "totals": {"totalCost": 1.50, "totalTokens": 150000},
  "activeSessions": [
    {
      "name": "project-name",
      "sessionId": "uuid",
      "tty": "pts/0",
      "cwd": "/path/to/project",
      "display": "first line of session",
      "status": "active",
      "needsInput": false
    }
  ],
  "completedSessions": [
    {
      "name": "project-name",
      "sessionId": "uuid",
      "cwd": "/path/to/project",
      "display": "first line of session",
      "status": "completed",
      "updatedAt": 1705234567
    }
  ],
  "updated": "2025-01-14T12:00:00Z"
}
```

## Dependencies

### Required
- macOS
- Ãœbersicht (widget engine)
- ccusage CLI (`pnpm add -g ccusage`)
- jq (JSON processor)
- Claude Code CLI
- gh CLI (GitHub CLI, `brew install gh`)

### Optional
- Ghostty terminal (for session resume feature)
- Volta (JavaScript runtime manager)

## Installation

1. Install Ãœbersicht from https://tracesof.net/uebersicht/
2. Copy `claude-sessions.jsx` to `~/Library/Application Support/Ãœbersicht/widgets/`
3. Copy `update-usage-cache.sh` to `~/.claude/cache/`
4. Copy `com.claude.usage-cache.plist` to `~/Library/LaunchAgents/`
5. Load the launch agent: `launchctl load ~/Library/LaunchAgents/com.claude.usage-cache.plist`

## Configuration

### Widget Settings (in claude-sessions.jsx)
- Position: `bottom: 20px`, `left: 20px`
- Size: `width: 50%`, `height: 70%`
- Layout: Two-column (left: Claude, right: GitHub PRs)
- Refresh rate: `10000ms` (10 seconds)

### Background Script (in com.claude.usage-cache.plist)
- Execution interval: `60` seconds
- Log output: `~/.claude/cache/update.log`

## Key Functions

### claude-sessions.jsx
- `command`: Shell command to read cache, hidden flag, and GitHub PRs
- `render()`: Main UI render function with two-column layout
- `getBarColor()`: Color calculation for chart bars
- `openSessionInGhostty()`: AppleScript-based terminal control
- `openInBrowser()`: Opens URLs in default browser
- `hideWidget()` / `showWidget()`: Visibility toggle

### update-usage-cache.sh
- Session detection via process listing
- History parsing with jq
- Project directory scanning
- Pending input detection (reads ~/.claude/cache/pending-input/)
- Atomic cache file updates

## Limitations

- Ghostty control uses AppleScript workaround (native API pending)
- Session detection requires matching history entries
- Active session detection excludes background processes (TTY != ??)
